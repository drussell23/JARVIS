<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JARVIS - System Initialization</title>
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
    <meta name="theme-color" content="#0a0a12" />
    <link
        href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;900&family=Share+Tech+Mono&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --neon-cyan: #00ffff;
            --neon-green: #00ff41;
            --glow-cyan: rgba(0, 255, 255, 0.8);
            --glow-green: rgba(0, 255, 65, 0.8);
            --bg-dark: #0a0a12;
            --reactor-blue: #00d4ff;
            --reactor-glow: rgba(0, 212, 255, 0.6);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html,
        body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: var(--bg-dark);
        }

        body {
            font-family: 'Orbitron', sans-serif;
        }

        /* Matrix Rain Canvas - Background layer */
        #matrix-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 1;
            opacity: 0.3;
            pointer-events: none;
        }

        /* Main Container */
        .loading-screen-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: transparent;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2;
        }

        /* J.A.R.V.I.S. Main Title */
        .jarvis-main-title {
            position: absolute;
            top: 12%;
            left: 50%;
            transform: translateX(-50%);
            font-family: 'Orbitron', sans-serif;
            font-size: 3.5rem;
            font-weight: 700;
            color: var(--neon-green);
            letter-spacing: 0.3em;
            text-shadow:
                0 0 10px var(--glow-green),
                0 0 20px var(--glow-green),
                0 0 40px var(--glow-green);
            animation: titlePulse 3s ease-in-out infinite;
        }

        @keyframes titlePulse {
            0%, 100% { opacity: 1; text-shadow: 0 0 10px var(--glow-green), 0 0 20px var(--glow-green), 0 0 40px var(--glow-green); }
            50% { opacity: 0.9; text-shadow: 0 0 15px var(--glow-green), 0 0 30px var(--glow-green), 0 0 60px var(--glow-green); }
        }

        /* System Startup Subtitle */
        #dynamic-title {
            position: absolute;
            top: 20%;
            left: 50%;
            transform: translateX(-50%);
            font-family: 'Share Tech Mono', monospace;
            font-size: 1rem;
            font-weight: 400;
            color: var(--neon-green);
            letter-spacing: 0.4em;
            text-transform: uppercase;
            opacity: 0.7;
            transition: all 0.5s ease;
        }

        /* ==================== ARC REACTOR ==================== */
        .arc-reactor-wrapper {
            position: relative;
            --reactor-size: clamp(240px, 45vmin, 320px);
            /* Overall reactor position tweak (useful if the whole reactor feels off-center) */
            --reactor-offset-x: 0px;
            --reactor-offset-y: 0px;
            /* Fine-tune overlay alignment without changing the reactor geometry */
            --overlay-offset-x: 0px;
            --overlay-offset-y: -12px;
            width: var(--reactor-size);
            height: var(--reactor-size);
            display: flex;
            justify-content: center;
            align-items: center;
            transform: translate(var(--reactor-offset-x), var(--reactor-offset-y));
        }

        .arc-reactor {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
        }

        /* Outer Ring */
        .reactor-ring {
            position: absolute;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .ring-outer {
            width: calc(var(--reactor-size) * 0.9375);
            height: calc(var(--reactor-size) * 0.9375);
            border: 3px solid var(--neon-green);
            opacity: 0.4;
            box-shadow:
                0 0 20px var(--glow-green),
                inset 0 0 20px var(--glow-green);
            animation: ringRotate 30s linear infinite;
        }

        .ring-middle {
            width: calc(var(--reactor-size) * 0.75);
            height: calc(var(--reactor-size) * 0.75);
            border: 2px solid var(--neon-green);
            opacity: 0.5;
            box-shadow:
                0 0 15px var(--glow-green),
                inset 0 0 15px var(--glow-green);
            animation: ringRotate 20s linear infinite reverse;
        }

        .ring-inner {
            width: calc(var(--reactor-size) * 0.5625);
            height: calc(var(--reactor-size) * 0.5625);
            border: 2px solid var(--neon-green);
            opacity: 0.6;
            box-shadow:
                0 0 10px var(--glow-green),
                inset 0 0 10px var(--glow-green);
            animation: ringRotate 15s linear infinite;
        }

        @keyframes ringRotate {
            from { transform: translate(-50%, -50%) rotate(0deg); }
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }

        /* Core glow */
        .reactor-core {
            position: absolute;
            width: calc(var(--reactor-size) * 0.375);
            height: calc(var(--reactor-size) * 0.375);
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border-radius: 50%;
            background: radial-gradient(circle,
                rgba(0, 255, 65, 0.3) 0%,
                rgba(0, 255, 65, 0.1) 50%,
                transparent 70%);
            box-shadow:
                0 0 60px var(--glow-green),
                0 0 100px var(--glow-green);
            animation: corePulse 2s ease-in-out infinite;
        }

        @keyframes corePulse {
            0%, 100% {
                transform: translate(-50%, -50%) scale(1);
                box-shadow: 0 0 60px var(--glow-green), 0 0 100px var(--glow-green);
            }
            50% {
                transform: translate(-50%, -50%) scale(1.1);
                box-shadow: 0 0 80px var(--glow-green), 0 0 140px var(--glow-green);
            }
        }

        /* Core center dot */
        .reactor-center {
            position: absolute;
            width: calc(var(--reactor-size) * 0.0625);
            height: calc(var(--reactor-size) * 0.0625);
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border-radius: 50%;
            background: var(--neon-green);
            box-shadow:
                0 0 20px var(--neon-green),
                0 0 40px var(--neon-green),
                0 0 60px var(--neon-green);
            animation: centerGlow 1.5s ease-in-out infinite;
        }

        @keyframes centerGlow {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Ring segments/notches */
        .ring-segments {
            position: absolute;
            width: calc(var(--reactor-size) * 0.8125);
            height: calc(var(--reactor-size) * 0.8125);
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            animation: ringRotate 25s linear infinite reverse;
        }

        .ring-segment {
            position: absolute;
            width: calc(var(--reactor-size) * 0.025);
            height: calc(var(--reactor-size) * 0.078125);
            background: var(--neon-green);
            border-radius: calc(var(--reactor-size) * 0.0125);
            box-shadow: 0 0 10px var(--glow-green);
            opacity: 0.8;
        }

        /* Position 8 segments around the ring */
        .ring-segment:nth-child(1) { top: 0; left: 50%; transform: translateX(-50%); }
        .ring-segment:nth-child(2) { top: 15%; right: 15%; transform: rotate(45deg); }
        .ring-segment:nth-child(3) { top: 50%; right: 0; transform: translateY(-50%) rotate(90deg); }
        .ring-segment:nth-child(4) { bottom: 15%; right: 15%; transform: rotate(135deg); }
        .ring-segment:nth-child(5) { bottom: 0; left: 50%; transform: translateX(-50%) rotate(180deg); }
        .ring-segment:nth-child(6) { bottom: 15%; left: 15%; transform: rotate(225deg); }
        .ring-segment:nth-child(7) { top: 50%; left: 0; transform: translateY(-50%) rotate(270deg); }
        .ring-segment:nth-child(8) { top: 15%; left: 15%; transform: rotate(315deg); }

        /* Percentage overlay - centered in reactor */
        .dynamic-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform:
                translate(-50%, -50%)
                translate(var(--overlay-offset-x), var(--overlay-offset-y));
            text-align: center;
            z-index: 10;
            pointer-events: none;
        }

        #dynamic-percentage {
            font-family: 'Orbitron', monospace;
            font-size: clamp(2rem, calc(var(--reactor-size) * 0.12), 3rem);
            font-weight: 700;
            color: var(--neon-green);
            line-height: 1;
            text-shadow:
                0 0 10px var(--glow-green),
                0 0 20px var(--glow-green),
                0 0 40px var(--glow-green);
            letter-spacing: 0.05em;
            transition: all 0.3s ease;
        }

        #dynamic-percentage.success {
            color: #00ff41;
            text-shadow: 0 0 30px #00ff41, 0 0 60px #00ff41, 0 0 100px #00ff41;
            animation: pulseGlow 0.5s ease-in-out 3;
        }

        @keyframes pulseGlow {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        #dynamic-subtitle {
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.65rem;
            color: var(--neon-green);
            letter-spacing: 3px;
            margin-top: 5px;
            opacity: 0.7;
            transition: all 0.3s ease;
        }

        /* Progress Bar */
        .progress-container {
            position: absolute;
            bottom: 28%;
            left: 50%;
            transform: translateX(-50%);
            width: 400px;
            max-width: 80vw;
        }

        .progress-bar-bg {
            width: 100%;
            height: 8px;
            background: rgba(0, 255, 65, 0.1);
            border-radius: 4px;
            border: 1px solid rgba(0, 255, 65, 0.3);
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, var(--neon-green), #00ff88);
            border-radius: 4px;
            box-shadow: 0 0 15px var(--glow-green);
            transition: width 0.3s ease;
        }

        /* Status Text */
        #dynamic-status {
            position: absolute;
            bottom: 22%;
            left: 50%;
            transform: translateX(-50%);
            font-family: 'Orbitron', monospace;
            font-size: 0.9rem;
            font-weight: 400;
            color: var(--neon-green);
            text-shadow: 0 0 5px var(--glow-green);
            letter-spacing: 0.08em;
            white-space: nowrap;
            text-align: center;
            max-width: 90vw;
            overflow: hidden;
            text-overflow: ellipsis;
            transition: all 0.3s ease;
        }

        /* Connected to server text */
        .server-status {
            position: absolute;
            bottom: 16%;
            left: 50%;
            transform: translateX(-50%);
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.75rem;
            color: var(--neon-green);
            opacity: 0.6;
            letter-spacing: 0.1em;
        }

        /* Connection Status Indicator */
        .conn-status {
            position: fixed;
            top: 18px;
            right: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 7px 14px;
            background: rgba(0, 20, 30, 0.85);
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 5px;
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.7rem;
            color: var(--neon-cyan);
            z-index: 100;
        }

        .conn-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #ffaa00;
            box-shadow: 0 0 6px #ffaa00;
            transition: all 0.3s ease;
        }

        .conn-dot.connected {
            background: var(--neon-green);
            box-shadow: 0 0 6px var(--neon-green);
        }

        /* Error State */
        .error-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(20, 0, 0, 0.95);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .error-overlay.visible {
            display: flex;
        }

        .error-title {
            font-size: 1.8rem;
            color: #ff4444;
            margin-bottom: 15px;
        }

        .error-msg {
            font-family: 'Share Tech Mono', monospace;
            color: #ff8888;
            max-width: 450px;
            text-align: center;
        }

        /* Matrix Transition Overlay */
        .transition-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: transparent;
            opacity: 0;
            pointer-events: none;
            z-index: 200;
            transition: opacity 0.8s ease-in;
        }

        .transition-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        /* Matrix transition canvas */
        #transition-matrix-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        /* Hidden elements for JS compatibility with loading-manager.js */
        #progress-bar {
            display: none;
        }

        #particles {
            display: none;
        }
    </style>
</head>

<body>
    <!-- Matrix Rain Background Canvas -->
    <canvas id="matrix-canvas"></canvas>

    <!-- Connection Status -->
    <div class="conn-status">
        <div class="conn-dot" id="status-indicator"></div>
        <span id="status-text">Connecting...</span>
    </div>

    <!-- Main Loading Screen Container -->
    <div class="loading-screen-container" id="loading-container">
        <!-- J.A.R.V.I.S. Main Title -->
        <h1 class="jarvis-main-title">J.A.R.V.I.S.</h1>

        <!-- System Startup Subtitle -->
        <h2 id="dynamic-title">SYSTEM STARTUP</h2>

        <!-- Arc Reactor with Percentage -->
        <div class="arc-reactor-wrapper">
            <div class="arc-reactor">
                <!-- Concentric Rings -->
                <div class="reactor-ring ring-outer"></div>
                <div class="reactor-ring ring-middle"></div>
                <div class="reactor-ring ring-inner"></div>

                <!-- Ring Segments -->
                <div class="ring-segments">
                    <div class="ring-segment"></div>
                    <div class="ring-segment"></div>
                    <div class="ring-segment"></div>
                    <div class="ring-segment"></div>
                    <div class="ring-segment"></div>
                    <div class="ring-segment"></div>
                    <div class="ring-segment"></div>
                    <div class="ring-segment"></div>
                </div>

                <!-- Core Glow -->
                <div class="reactor-core"></div>
                <div class="reactor-center"></div>
            </div>

            <!-- Percentage Overlay - Centered in Reactor -->
            <div class="dynamic-overlay">
                <h1 id="dynamic-percentage">0%</h1>
                <div id="dynamic-subtitle">INITIALIZING</div>
            </div>
        </div>

        <!-- Progress Bar -->
        <div class="progress-container">
            <div class="progress-bar-bg">
                <div class="progress-bar-fill" id="progress-bar-visual"></div>
            </div>
        </div>

        <!-- Status Text -->
        <p id="dynamic-status">Initializing JARVIS Systems...</p>

        <!-- Server Connection Status -->
        <p class="server-status" id="server-status">Connected to server</p>
    </div>

    <!-- Hidden elements for loading-manager.js compatibility -->
    <div id="progress-bar" style="width:0%"></div>
    <div id="progress-percentage" style="display:none;">0%</div>
    <div id="status-message" style="display:none;">Loading...</div>
    <div id="particles"></div>

    <!-- Error Overlay -->
    <div class="error-overlay" id="error-container">
        <div class="error-title">SYSTEM FAILURE</div>
        <div class="error-msg" id="error-message">An error occurred.</div>
    </div>

    <!-- Transition Overlay with Matrix Canvas -->
    <div class="transition-overlay" id="transition-overlay">
        <canvas id="transition-matrix-canvas"></canvas>
    </div>

    <script>
        // =====================================================
        // Matrix Rain Animation System
        // =====================================================
        class MatrixRain {
            constructor(canvasId, options = {}) {
                this.canvas = document.getElementById(canvasId);
                if (!this.canvas) return;

                this.ctx = this.canvas.getContext('2d');
                this.options = {
                    fontSize: options.fontSize || 14,
                    color: options.color || '#00ff41',
                    fadeColor: options.fadeColor || 'rgba(10, 10, 18, 0.05)',
                    speed: options.speed || 1,
                    density: options.density || 0.98,
                    characters: options.characters || 'JARVISACCESS0123456789@#$%&*GRANTED',
                    ...options
                };

                this.columns = [];
                this.animationId = null;
                this.isRunning = false;

                this.resize();
                window.addEventListener('resize', () => this.resize());
            }

            resize() {
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;

                const columnCount = Math.floor(this.canvas.width / this.options.fontSize);
                this.columns = [];
                for (let i = 0; i < columnCount; i++) {
                    this.columns.push({
                        y: Math.random() * this.canvas.height,
                        speed: 0.5 + Math.random() * this.options.speed
                    });
                }
            }

            draw() {
                // Fade effect
                this.ctx.fillStyle = this.options.fadeColor;
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);

                // Draw characters
                this.ctx.fillStyle = this.options.color;
                this.ctx.font = `${this.options.fontSize}px 'Share Tech Mono', monospace`;

                for (let i = 0; i < this.columns.length; i++) {
                    const col = this.columns[i];
                    const char = this.options.characters[Math.floor(Math.random() * this.options.characters.length)];
                    const x = i * this.options.fontSize;

                    // Draw with glow effect for some characters
                    if (Math.random() > 0.95) {
                        this.ctx.shadowColor = this.options.color;
                        this.ctx.shadowBlur = 10;
                    } else {
                        this.ctx.shadowBlur = 0;
                    }

                    this.ctx.fillText(char, x, col.y);

                    // Move column down
                    col.y += this.options.fontSize * col.speed;

                    // Reset column if off screen
                    if (col.y > this.canvas.height && Math.random() > this.options.density) {
                        col.y = 0;
                        col.speed = 0.5 + Math.random() * this.options.speed;
                    }
                }
            }

            start() {
                if (this.isRunning) return;
                this.isRunning = true;

                const animate = () => {
                    if (!this.isRunning) return;
                    this.draw();
                    this.animationId = requestAnimationFrame(animate);
                };
                animate();
            }

            stop() {
                this.isRunning = false;
                if (this.animationId) {
                    cancelAnimationFrame(this.animationId);
                    this.animationId = null;
                }
            }

            intensify() {
                // Speed up and brighten for transition
                this.options.speed = 3;
                this.options.fadeColor = 'rgba(10, 10, 18, 0.02)';
                this.options.color = '#00ff88';
                this.resize();
            }
        }

        // Initialize background matrix rain
        let backgroundMatrix = null;
        let transitionMatrix = null;

        // =====================================================
        // Dynamic Title based on URL params
        // =====================================================
        function setTitle() {
            const t = document.getElementById('dynamic-title');
            const p = new URLSearchParams(location.search);
            const m = p.get('mode');
            if (m === 'restart' || location.href.includes('restart')) t.textContent = 'SYSTEM RESTART';
            else if (m === 'init') t.textContent = 'SYSTEM INITIALIZATION';
            else t.textContent = 'SYSTEM STARTUP';
        }

        // =====================================================
        // Success State
        // =====================================================
        let successDone = false;
        let transitionInProgress = false;

        function triggerSuccessState() {
            if (successDone) return Promise.resolve();
            successDone = true;
            return new Promise(res => {
                const pct = document.getElementById('dynamic-percentage');
                const title = document.getElementById('dynamic-title');
                const mainTitle = document.querySelector('.jarvis-main-title');
                const status = document.getElementById('dynamic-status');
                const subtitle = document.getElementById('dynamic-subtitle');
                const indicator = document.getElementById('status-indicator');
                const statusText = document.getElementById('status-text');
                const progressBarVisual = document.getElementById('progress-bar-visual');
                const serverStatus = document.getElementById('server-status');
                const reactorCore = document.querySelector('.reactor-core');
                const reactorCenter = document.querySelector('.reactor-center');
                const rings = document.querySelectorAll('.reactor-ring');
                const segments = document.querySelectorAll('.ring-segment');

                if (pct) pct.classList.add('success');
                if (title) {
                    title.textContent = 'ACCESS GRANTED';
                    title.style.color = '#00ff41';
                    title.style.textShadow = '0 0 20px #00ff41, 0 0 40px #00ff41, 0 0 60px #00ff41';
                }
                if (status) status.textContent = 'System Ready - All Services Online';
                if (subtitle) subtitle.textContent = 'COMPLETE';
                if (indicator) indicator.classList.add('connected');
                if (statusText) statusText.textContent = 'Connected';
                if (progressBarVisual) {
                    progressBarVisual.style.width = '100%';
                    progressBarVisual.style.boxShadow = '0 0 30px var(--glow-green)';
                }
                if (serverStatus) serverStatus.textContent = 'All systems operational';

                // Intensify reactor glow
                if (reactorCore) {
                    reactorCore.style.boxShadow = '0 0 100px var(--glow-green), 0 0 150px var(--glow-green)';
                }
                if (reactorCenter) {
                    reactorCenter.style.transform = 'translate(-50%, -50%) scale(1.2)';
                    reactorCenter.style.boxShadow = '0 0 30px var(--neon-green), 0 0 60px var(--neon-green), 0 0 90px var(--neon-green)';
                }
                rings.forEach(ring => {
                    ring.style.opacity = '0.8';
                    ring.style.boxShadow = '0 0 30px var(--glow-green), inset 0 0 30px var(--glow-green)';
                });
                segments.forEach(seg => {
                    seg.style.opacity = '1';
                    seg.style.boxShadow = '0 0 20px var(--glow-green)';
                });

                // Intensify background matrix
                if (backgroundMatrix) {
                    backgroundMatrix.options.color = '#00ff41';
                    backgroundMatrix.options.speed = 2;
                }

                setTimeout(res, 800);
            });
        }
        window.triggerSuccessState = triggerSuccessState;

        // =====================================================
        // Observers for loading-manager.js compatibility
        // =====================================================
        function setupObservers() {
            const hiddenPct = document.getElementById('progress-percentage');
            const hiddenMsg = document.getElementById('status-message');
            const bar = document.getElementById('progress-bar');

            const displayPct = document.getElementById('dynamic-percentage');
            const displayStatus = document.getElementById('dynamic-status');
            const subtitle = document.getElementById('dynamic-subtitle');
            const progressBarVisual = document.getElementById('progress-bar-visual');
            const serverStatus = document.getElementById('server-status');

            // Update subtitle based on progress
            function updateSubtitle(progress) {
                if (!subtitle) return;
                if (progress < 20) subtitle.textContent = 'CLEANUP';
                else if (progress < 40) subtitle.textContent = 'PREPARING';
                else if (progress < 60) subtitle.textContent = 'STARTING';
                else if (progress < 80) subtitle.textContent = 'LOADING';
                else if (progress < 95) subtitle.textContent = 'FINALIZING';
                else if (progress < 100) subtitle.textContent = 'READY';
                else subtitle.textContent = 'COMPLETE';
            }

            // Update visual progress bar
            function updateProgressBar(progress) {
                if (progressBarVisual) {
                    progressBarVisual.style.width = progress + '%';
                }
            }

            // Observe hidden percentage and sync to visible element
            if (hiddenPct && displayPct) {
                new MutationObserver(() => {
                    const t = hiddenPct.textContent;
                    displayPct.textContent = t;
                    const match = t.match(/(\d+)/);
                    if (match) {
                        const v = parseInt(match[1]);
                        updateSubtitle(v);
                        updateProgressBar(v);
                        if (v >= 100 && !successDone) {
                            triggerSuccessState();
                        }
                    }
                }).observe(hiddenPct, { childList: true, characterData: true, subtree: true });
            }

            // Observe hidden message and sync to visible element
            if (hiddenMsg && displayStatus) {
                new MutationObserver(() => {
                    displayStatus.textContent = hiddenMsg.textContent;
                }).observe(hiddenMsg, { childList: true, characterData: true, subtree: true });
            }

            // Observe progress bar width
            if (bar && displayPct) {
                new MutationObserver(ms => {
                    ms.forEach(m => {
                        if (m.attributeName === 'style') {
                            const w = bar.style.width;
                            const v = parseFloat(w);
                            if (!isNaN(v)) {
                                displayPct.textContent = Math.round(v) + '%';
                                updateSubtitle(v);
                                updateProgressBar(v);
                                if (v >= 100 && !successDone) {
                                    triggerSuccessState();
                                }
                            }
                        }
                    });
                }).observe(bar, { attributes: true });
            }
        }

        // =====================================================
        // Matrix Transition Effect
        // =====================================================
        async function triggerMatrixTransition(redirectUrl) {
            if (transitionInProgress) return;
            transitionInProgress = true;

            console.log('[Transition] Starting Matrix transition to:', redirectUrl);

            const overlay = document.getElementById('transition-overlay');
            const container = document.getElementById('loading-container');
            const matrixCanvas = document.getElementById('matrix-canvas');

            // Initialize transition matrix
            transitionMatrix = new MatrixRain('transition-matrix-canvas', {
                fontSize: 16,
                color: '#00ff41',
                fadeColor: 'rgba(0, 0, 0, 0.1)',
                speed: 4,
                density: 0.95,
                characters: 'ACCESSGRANTED01JARVIS'
            });

            // Phase 1: Show transition overlay and start intense matrix
            if (overlay) {
                overlay.classList.add('active');
                transitionMatrix.start();
            }

            // Phase 2: Fade out main content while matrix intensifies
            await sleep(200);

            if (container) {
                container.style.transition = 'all 0.8s ease-out';
                container.style.opacity = '0';
                container.style.transform = 'scale(1.1)';
                container.style.filter = 'blur(10px) brightness(1.5)';
            }

            if (backgroundMatrix) {
                backgroundMatrix.intensify();
            }

            // Phase 3: Full matrix takeover
            await sleep(600);

            if (matrixCanvas) {
                matrixCanvas.style.transition = 'opacity 0.5s ease-out';
                matrixCanvas.style.opacity = '1';
            }

            // Phase 4: Create warp/zoom effect
            await sleep(400);

            const transitionCanvas = document.getElementById('transition-matrix-canvas');
            if (transitionCanvas) {
                transitionCanvas.style.transition = 'all 0.6s ease-in';
                transitionCanvas.style.transform = 'scale(1.5)';
                transitionCanvas.style.filter = 'brightness(2) blur(3px)';
            }

            // Phase 5: Final fade to black and redirect
            await sleep(400);

            // Create final black overlay
            const finalOverlay = document.createElement('div');
            finalOverlay.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: #0a0a12; opacity: 0;
                transition: opacity 0.4s ease-in; z-index: 10001;
            `;
            document.body.appendChild(finalOverlay);

            await sleep(50);
            finalOverlay.style.opacity = '1';

            await sleep(400);

            // Redirect
            console.log('[Transition] Redirecting to:', redirectUrl);
            window.location.href = redirectUrl;
        }

        // Legacy transition function - now uses Matrix transition
        function triggerTransition(redirectUrl) {
            triggerMatrixTransition(redirectUrl);
        }
        window.triggerTransition = triggerTransition;
        window.triggerMatrixTransition = triggerMatrixTransition;

        // =====================================================
        // Utility Functions
        // =====================================================
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // =====================================================
        // Connection Status Updates
        // =====================================================
        function updateConnectionStatus(connected, text) {
            const indicator = document.getElementById('status-indicator');
            const statusText = document.getElementById('status-text');
            const serverStatus = document.getElementById('server-status');

            if (indicator) {
                indicator.classList.toggle('connected', connected);
            }
            if (statusText && text) {
                statusText.textContent = text;
            }
            if (serverStatus) {
                serverStatus.textContent = connected ? 'Connected to server' : 'Connecting...';
            }
        }
        window.updateConnectionStatus = updateConnectionStatus;

        // =====================================================
        // Init
        // =====================================================
        document.addEventListener('DOMContentLoaded', () => {
            setTitle();
            setupObservers();

            // Start background matrix rain
            backgroundMatrix = new MatrixRain('matrix-canvas', {
                fontSize: 14,
                color: '#00ff41',
                fadeColor: 'rgba(10, 10, 18, 0.05)',
                speed: 1,
                density: 0.98
            });
            backgroundMatrix.start();

            console.log('[Loading] Matrix rain initialized');
        });
    </script>

    <script src="/loading-manager.js"></script>
</body>

</html>