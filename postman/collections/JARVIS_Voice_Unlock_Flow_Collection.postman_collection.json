{
  "info": {
    "_postman_id": "jarvis-voice-unlock-flow-2024",
    "name": "JARVIS Voice Unlock Flow (Sequential)",
    "description": "Sequential collection that mimics the Voice Unlock Authentication Flow.\n\n‚ö†Ô∏è IMPORTANT: Make sure JARVIS backend is running on port 8010 before executing!\n\nTo start backend:\n```\ncd backend && python main.py\n```\n\nOr use start_system.py\n\nRun this collection with the Collection Runner to execute the full authentication pipeline.\n\n‚è±Ô∏è Set timeout in Postman Settings ‚Üí General ‚Üí Request timeout (recommend 5000ms)",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "variable": [
    {
      "key": "base_url",
      "value": "http://localhost:8010",
      "type": "string"
    },
    {
      "key": "speaker_name",
      "value": "Derek",
      "type": "string"
    },
    {
      "key": "confidence_threshold",
      "value": "0.85",
      "type": "string"
    },
    {
      "key": "voice_confidence",
      "value": "0",
      "type": "string"
    },
    {
      "key": "fused_confidence",
      "value": "0",
      "type": "string"
    },
    {
      "key": "audit_session_id",
      "value": "",
      "type": "string"
    },
    {
      "key": "auth_result",
      "value": "",
      "type": "string"
    },
    {
      "key": "should_unlock",
      "value": "false",
      "type": "string"
    }
  ],
  "event": [
    {
      "listen": "prerequest",
      "script": {
        "type": "text/javascript",
        "exec": [
          "// Global pre-request: Set timeout for all requests",
          "pm.request.timeout = 5000; // 5 second timeout"
        ]
      }
    }
  ],
  "item": [
    {
      "name": "0. Quick Backend Check",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "// Quick check if backend is reachable",
              "if (pm.response.code === 200) {",
              "    console.log('‚úÖ Backend is running');",
              "    pm.test('Backend is reachable', function() {",
              "        pm.response.to.have.status(200);",
              "    });",
              "} else {",
              "    console.error('‚ùå Backend returned unexpected status: ' + pm.response.code);",
              "    pm.execution.setNextRequest(null);",
              "}"
            ],
            "type": "text/javascript"
          }
        },
        {
          "listen": "prerequest",
          "script": {
            "exec": [
              "console.log('üîç Checking if JARVIS backend is running on ' + pm.collectionVariables.get('base_url'));"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{base_url}}/health",
          "host": ["{{base_url}}"],
          "path": ["health"]
        },
        "description": "Quick check to verify backend is running before starting the flow"
      }
    },
    {
      "name": "1. System Health Check",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "// Handle connection errors",
              "if (!pm.response) {",
              "    console.error('‚ùå No response - backend may not be running');",
              "    pm.execution.setNextRequest(null);",
              "    return;",
              "}",
              "",
              "try {",
              "    const response = pm.response.json();",
              "    ",
              "    pm.test('System is healthy', function() {",
              "        pm.expect(response.status).to.be.oneOf(['healthy', 'degraded', 'ok']);",
              "    });",
              "    ",
              "    // If unhealthy, skip remaining requests",
              "    if (response.status === 'unhealthy' || response.status === 'error') {",
              "        pm.execution.setNextRequest('Error: System Unavailable');",
              "        console.log('‚ö†Ô∏è System unhealthy - skipping to error handler');",
              "    } else {",
              "        console.log('‚úÖ System health: ' + response.status);",
              "    }",
              "} catch (e) {",
              "    console.error('‚ùå Failed to parse response: ' + e.message);",
              "    // Try to continue anyway if we got a 200",
              "    if (pm.response.code === 200) {",
              "        console.log('‚ÑπÔ∏è Got 200, continuing...');",
              "    } else {",
              "        pm.execution.setNextRequest(null);",
              "    }",
              "}"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{base_url}}/api/voice-auth-intelligence/health",
          "host": ["{{base_url}}"],
          "path": ["api", "voice-auth-intelligence", "health"]
        },
        "description": "Verify voice authentication system is operational before proceeding"
      }
    },
    {
      "name": "2. Start Audit Session",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "try {",
              "    const response = pm.response.json();",
              "    ",
              "    if (response.session_id) {",
              "        pm.collectionVariables.set('audit_session_id', response.session_id);",
              "        console.log('üìù Audit session started: ' + response.session_id);",
              "    } else {",
              "        // Generate a mock session ID if endpoint doesn't exist yet",
              "        const mockId = 'mock-' + Date.now();",
              "        pm.collectionVariables.set('audit_session_id', mockId);",
              "        console.log('‚ÑπÔ∏è Using mock audit session: ' + mockId);",
              "    }",
              "    ",
              "    pm.test('Audit session created or mocked', function() {",
              "        pm.expect(pm.collectionVariables.get('audit_session_id')).to.not.be.empty;",
              "    });",
              "} catch (e) {",
              "    console.log('‚ÑπÔ∏è Audit endpoint not available, using mock');",
              "    pm.collectionVariables.set('audit_session_id', 'mock-' + Date.now());",
              "}"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n    \"user_id\": \"{{speaker_name}}\",\n    \"source\": \"postman_flow\",\n    \"metadata\": {\n        \"flow_version\": \"1.0.0\"\n    }\n}"
        },
        "url": {
          "raw": "{{base_url}}/api/voice-auth-intelligence/audit/session/start",
          "host": ["{{base_url}}"],
          "path": ["api", "voice-auth-intelligence", "audit", "session", "start"]
        },
        "description": "Start Langfuse audit trail for this authentication attempt"
      }
    },
    {
      "name": "3. Anti-Spoofing Check",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "try {",
              "    const response = pm.response.json();",
              "    ",
              "    pm.test('No replay attack detected', function() {",
              "        pm.expect(response.is_replay).to.not.equal(true);",
              "    });",
              "    ",
              "    if (response.is_replay === true) {",
              "        pm.collectionVariables.set('auth_result', 'replay_attack');",
              "        pm.execution.setNextRequest('Error: Security Alert');",
              "        console.log('üö® SECURITY ALERT: Replay attack detected!');",
              "    } else {",
              "        console.log('‚úÖ Anti-spoofing check passed');",
              "    }",
              "} catch (e) {",
              "    // Endpoint may not exist yet - skip check",
              "    console.log('‚ÑπÔ∏è Anti-spoofing endpoint not available, skipping check');",
              "}"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n    \"check_exact_match\": true,\n    \"check_spectral_fingerprint\": true,\n    \"check_environmental_signature\": true\n}"
        },
        "url": {
          "raw": "{{base_url}}/api/voice-auth-intelligence/patterns/detect-replay",
          "host": ["{{base_url}}"],
          "path": ["api", "voice-auth-intelligence", "patterns", "detect-replay"]
        },
        "description": "Check if audio matches known replay attack patterns"
      }
    },
    {
      "name": "4. Voice Authentication (Simulate)",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "try {",
              "    const response = pm.response.json();",
              "    const confidence = response.confidence || response.voice_confidence || 0;",
              "    const threshold = parseFloat(pm.collectionVariables.get('confidence_threshold'));",
              "    ",
              "    pm.collectionVariables.set('voice_confidence', confidence.toString());",
              "    ",
              "    console.log('üé§ Voice confidence: ' + (confidence * 100).toFixed(1) + '%');",
              "    console.log('üìä Threshold: ' + (threshold * 100).toFixed(1) + '%');",
              "    ",
              "    pm.test('Voice authentication completed', function() {",
              "        pm.expect(confidence).to.be.a('number');",
              "    });",
              "    ",
              "    // Route based on confidence level",
              "    if (confidence >= 0.90) {",
              "        pm.collectionVariables.set('should_unlock', 'true');",
              "        pm.collectionVariables.set('auth_result', 'high_confidence');",
              "        pm.execution.setNextRequest('6. Unlock Screen');",
              "        console.log('üåü HIGH CONFIDENCE - Direct unlock');",
              "    } else if (confidence >= threshold) {",
              "        pm.collectionVariables.set('should_unlock', 'true');",
              "        pm.collectionVariables.set('auth_result', 'passed');",
              "        pm.execution.setNextRequest('6. Unlock Screen');",
              "        console.log('‚úÖ PASSED - Proceeding to unlock');",
              "    } else if (confidence >= 0.75) {",
              "        pm.collectionVariables.set('auth_result', 'borderline');",
              "        console.log('‚ö†Ô∏è BORDERLINE - Need multi-factor fusion');",
              "    } else {",
              "        pm.collectionVariables.set('should_unlock', 'false');",
              "        pm.collectionVariables.set('auth_result', 'failed');",
              "        pm.execution.setNextRequest('Error: Authentication Failed');",
              "        console.log('‚ùå FAILED - Low confidence');",
              "    }",
              "} catch (e) {",
              "    console.error('‚ùå Voice auth error: ' + e.message);",
              "    pm.collectionVariables.set('should_unlock', 'false');",
              "    pm.execution.setNextRequest('Error: Authentication Failed');",
              "}"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n    \"scenario\": \"success\",\n    \"speaker_name\": \"{{speaker_name}}\"\n}"
        },
        "url": {
          "raw": "{{base_url}}/api/voice-auth-intelligence/authenticate/simulate",
          "host": ["{{base_url}}"],
          "path": ["api", "voice-auth-intelligence", "authenticate", "simulate"]
        },
        "description": "Simulate voice authentication (use 'success', 'borderline', 'replay_attack', 'unknown_speaker' scenarios)"
      }
    },
    {
      "name": "5. Multi-Factor Fusion",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "try {",
              "    const response = pm.response.json();",
              "    const fusedConfidence = response.fused_confidence || 0;",
              "    ",
              "    pm.collectionVariables.set('fused_confidence', fusedConfidence.toString());",
              "    ",
              "    console.log('üß† Fused confidence: ' + (fusedConfidence * 100).toFixed(1) + '%');",
              "    ",
              "    pm.test('Multi-factor fusion completed', function() {",
              "        pm.expect(fusedConfidence).to.be.a('number');",
              "    });",
              "    ",
              "    if (fusedConfidence >= 0.80) {",
              "        pm.collectionVariables.set('should_unlock', 'true');",
              "        pm.collectionVariables.set('auth_result', 'fusion_passed');",
              "        console.log('‚úÖ FUSION PASSED - Proceeding to unlock');",
              "    } else {",
              "        pm.collectionVariables.set('should_unlock', 'false');",
              "        pm.collectionVariables.set('auth_result', 'fusion_failed');",
              "        pm.execution.setNextRequest('Error: Fusion Failed - Challenge Required');",
              "        console.log('‚ö†Ô∏è FUSION FAILED - Challenge required');",
              "    }",
              "} catch (e) {",
              "    console.log('‚ÑπÔ∏è Fusion endpoint not available, using voice confidence only');",
              "    const voiceConf = parseFloat(pm.collectionVariables.get('voice_confidence') || '0');",
              "    if (voiceConf >= 0.75) {",
              "        pm.collectionVariables.set('should_unlock', 'true');",
              "        pm.collectionVariables.set('auth_result', 'voice_only');",
              "    } else {",
              "        pm.collectionVariables.set('should_unlock', 'false');",
              "        pm.execution.setNextRequest('Error: Authentication Failed');",
              "    }",
              "}"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n    \"voice_confidence\": {{voice_confidence}},\n    \"behavioral_context\": {\n        \"time_of_day\": \"morning\",\n        \"typical_unlock_hour\": 7,\n        \"same_wifi_network\": true,\n        \"device_moved_since_lock\": false\n    },\n    \"weights\": {\n        \"voice\": 0.50,\n        \"behavioral\": 0.35,\n        \"context\": 0.15\n    },\n    \"apply_bonuses\": true\n}"
        },
        "url": {
          "raw": "{{base_url}}/api/voice-auth-intelligence/fusion/calculate",
          "host": ["{{base_url}}"],
          "path": ["api", "voice-auth-intelligence", "fusion", "calculate"]
        },
        "description": "Apply multi-factor fusion for borderline cases"
      }
    },
    {
      "name": "6. Unlock Screen",
      "event": [
        {
          "listen": "prerequest",
          "script": {
            "exec": [
              "const shouldUnlock = pm.collectionVariables.get('should_unlock');",
              "if (shouldUnlock !== 'true') {",
              "    console.log('‚è≠Ô∏è Skipping unlock - should_unlock is false');",
              "    pm.execution.setNextRequest('8. End Audit Session');",
              "}"
            ],
            "type": "text/javascript"
          }
        },
        {
          "listen": "test",
          "script": {
            "exec": [
              "try {",
              "    const response = pm.response.json();",
              "    ",
              "    pm.test('Screen unlock attempted', function() {",
              "        pm.response.to.have.status(200);",
              "    });",
              "    ",
              "    if (response.success) {",
              "        console.log('üîì Screen unlocked successfully!');",
              "    } else {",
              "        console.log('‚ö†Ô∏è Screen unlock response: ' + JSON.stringify(response));",
              "    }",
              "} catch (e) {",
              "    console.log('‚ÑπÔ∏è Unlock endpoint response: ' + pm.response.text());",
              "}"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n    \"method\": \"keychain\",\n    \"reason\": \"voice_biometric_authenticated\",\n    \"authenticated_user\": \"{{speaker_name}}\"\n}"
        },
        "url": {
          "raw": "{{base_url}}/api/screen/unlock",
          "host": ["{{base_url}}"],
          "path": ["api", "screen", "unlock"]
        },
        "description": "Execute screen unlock via keychain method"
      }
    },
    {
      "name": "7. JARVIS Success Feedback",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('JARVIS feedback sent', function() {",
              "    pm.response.to.have.status(200);",
              "});",
              "console.log('üîä JARVIS feedback delivered');"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n    \"text\": \"Unlocking for you, {{speaker_name}}.\"\n}"
        },
        "url": {
          "raw": "{{base_url}}/voice/jarvis/speak",
          "host": ["{{base_url}}"],
          "path": ["voice", "jarvis", "speak"]
        },
        "description": "Have JARVIS speak success feedback"
      }
    },
    {
      "name": "8. End Audit Session",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "const authResult = pm.collectionVariables.get('auth_result');",
              "const voiceConf = pm.collectionVariables.get('voice_confidence');",
              "const fusedConf = pm.collectionVariables.get('fused_confidence');",
              "",
              "console.log('');",
              "console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');",
              "console.log('     AUTHENTICATION SUMMARY');",
              "console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');",
              "console.log('Result: ' + authResult);",
              "console.log('Voice Confidence: ' + (parseFloat(voiceConf) * 100).toFixed(1) + '%');",
              "if (fusedConf && fusedConf !== '0') {",
              "    console.log('Fused Confidence: ' + (parseFloat(fusedConf) * 100).toFixed(1) + '%');",
              "}",
              "console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');",
              "",
              "pm.test('Flow completed', function() {",
              "    pm.expect(authResult).to.not.be.empty;",
              "});",
              "",
              "// Stop execution",
              "pm.execution.setNextRequest(null);"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n    \"session_id\": \"{{audit_session_id}}\",\n    \"status\": \"{{auth_result}}\",\n    \"voice_confidence\": {{voice_confidence}},\n    \"outcome\": \"flow_completed\"\n}"
        },
        "url": {
          "raw": "{{base_url}}/api/voice-auth-intelligence/audit/session/end",
          "host": ["{{base_url}}"],
          "path": ["api", "voice-auth-intelligence", "audit", "session", "end"]
        },
        "description": "Close Langfuse audit trail with final status"
      }
    },
    {
      "name": "Error: System Unavailable",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "console.log('‚ùå ERROR: Voice auth system unavailable');",
              "pm.execution.setNextRequest(null);"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n    \"text\": \"I'm having trouble with voice authentication right now. Please use your password to unlock.\"\n}"
        },
        "url": {
          "raw": "{{base_url}}/voice/jarvis/speak",
          "host": ["{{base_url}}"],
          "path": ["voice", "jarvis", "speak"]
        },
        "description": "Error handler when system is unavailable"
      }
    },
    {
      "name": "Error: Security Alert",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "console.log('üö® SECURITY ALERT: Possible replay attack detected');",
              "pm.execution.setNextRequest('8. End Audit Session');"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n    \"text\": \"Security alert: I detected characteristics consistent with a voice recording rather than a live person. Access denied. This attempt has been logged.\"\n}"
        },
        "url": {
          "raw": "{{base_url}}/voice/jarvis/speak",
          "host": ["{{base_url}}"],
          "path": ["voice", "jarvis", "speak"]
        },
        "description": "Security alert for replay attack detection"
      }
    },
    {
      "name": "Error: Authentication Failed",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "console.log('‚ùå Authentication failed - low confidence');",
              "pm.execution.setNextRequest('8. End Audit Session');"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n    \"text\": \"I'm having trouble verifying your voice. Could you try again, maybe speak a bit louder and closer to the microphone? Or you can use your password instead.\"\n}"
        },
        "url": {
          "raw": "{{base_url}}/voice/jarvis/speak",
          "host": ["{{base_url}}"],
          "path": ["voice", "jarvis", "speak"]
        },
        "description": "Error handler for failed voice authentication"
      }
    },
    {
      "name": "Error: Fusion Failed - Challenge Required",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "console.log('‚ö†Ô∏è Multi-factor fusion failed - challenge question required');",
              "pm.execution.setNextRequest('8. End Audit Session');"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n    \"text\": \"I need a quick verification. What was the last project you worked on yesterday?\"\n}"
        },
        "url": {
          "raw": "{{base_url}}/voice/jarvis/speak",
          "host": ["{{base_url}}"],
          "path": ["voice", "jarvis", "speak"]
        },
        "description": "Challenge question when fusion doesn't reach threshold"
      }
    }
  ]
}
